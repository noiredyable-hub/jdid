// ==UserScript==
// @name         QX NILOY V1.8.9 + Leaderboard Real Avatar Sync
// @version      7.8.20-final
// @description  Demo Balance Update + Leaderboard with real balance sync (Row shows $30,000.00+)
// @author       QX + Gemini Update
// @match        *://market-qx.trade/*
// @grant        none
// @run-at       document-start
// ==/UserScript==

(function () {
    'use strict';

    // ‡ßß. ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶°‡¶ø‡¶ü‡ßá‡¶ï‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
    const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const targetName = isMobile ? "Live" : "Live Account";
    
    // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶°‡ßá‡¶Æ‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ (‡¶Ø‡¶æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶¨‡ßá)
    let customDemoBalance = 10000.00;
    
    // Leaderboard localStorage keys
    const lbProfitKey = "sltechbd_lb_profit";
    const lbNameKey = "sltechbd_lb_name";

    // ‡ß®. CSS Injection
    const style = document.createElement('style');
    style.innerHTML = `
        .---react-features-Usermenu-styles-module__demo--TmWTp { 
            color: #0faf59 !important; 
        }
        .---react-features-Usermenu-styles-module__infoName--SfrTV {
            transition: none !important;
        }
        
        /* Professional Modal Styles */
        .qx-settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            opacity: 0;
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .qx-settings-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9) translateY(20px);
            animation: slideUp 0.3s ease-out forwards;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .qx-settings-modal-header {
            color: #ffffff !important;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-smooth: always;
            animation: none !important;
            transition: none !important;
            will-change: auto;
            backface-visibility: visible;
            transform: none !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .qx-settings-form-group {
            margin-bottom: 20px;
        }
        
        .qx-settings-label {
            display: block;
            color: #e0e0e0;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .qx-settings-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #ffffff;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .qx-settings-input:focus {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
        }
        
        .qx-settings-input::placeholder {
            color: #666;
        }
        
        .qx-telegram-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px 24px;
            margin-top: 8px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #0088cc 0%, #006ba3 100%);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .qx-telegram-button:hover {
            background: linear-gradient(135deg, #006ba3 0%, #005a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.4);
        }
        
        .qx-telegram-button:active {
            transform: translateY(0);
        }
        
        .qx-telegram-button svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .qx-telegram-button span {
            line-height: 1;
        }
        
        .qx-settings-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #ffffff;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
            box-sizing: border-box;
        }
        
        .qx-settings-select:focus {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
        }
        
        .qx-settings-select option {
            background: #1a1a2e;
            color: #ffffff;
        }
        
        .qx-settings-buttons {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }
        
        .qx-settings-btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .qx-settings-btn-save {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }
        
        .qx-settings-btn-save:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }
        
        .qx-settings-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .qx-settings-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            to {
                transform: scale(1) translateY(0);
            }
        }
        
        .qx-settings-modal-overlay.closing {
            animation: fadeOut 0.2s ease-out forwards;
        }
        
        .qx-settings-modal.closing {
            animation: slideDown 0.2s ease-out forwards;
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        
        @keyframes slideDown {
            to {
                transform: scale(0.9) translateY(20px);
            }
        }
    `;
    document.head ? document.head.appendChild(style) : document.documentElement.appendChild(style);

    // ‡ß©. ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï
    if (location.pathname === "/en/trade") {
        location.replace("/en/demo-trade");
        return;
    }

    const selectors = {
        usermenuBalance: ".---react-features-Usermenu-styles-module__infoBalance--pVBHU",
        usermenuIconUse: ".---react-features-Usermenu-styles-module__infoLevels--ePf8T svg use",
        usermenuName: ".---react-features-Usermenu-styles-module__infoName--SfrTV",
        levelName: ".---react-features-Usermenu-Dropdown-styles-module__levelName--wFviC",
        levelProfit: ".---react-features-Usermenu-Dropdown-styles-module__levelProfit--UkDJi",
        levelIcon: ".---react-features-Usermenu-Dropdown-styles-module__levelIcon--lmj_k svg use",
        usermenuListItems: "li"
    };

    const activeClass = '---react-features-Usermenu-Dropdown-styles-module__active--P5n2A';
    const numFromText = s => s ? parseFloat(s.replace(/[^0-9.]/g, "")) : 0;
    const formatAmount = num => "$" + num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    // ‡ß™. ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶ì ‡¶á‡¶â‡¶Ü‡¶∞‡¶è‡¶≤ ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ï‡¶ø‡¶Ç
    function maskUI() {
        if (document.title !== "Live trading | Quotex") document.title = "Live trading | Quotex";
        if (!location.href.includes("/trade")) {
            history.replaceState(null, "", "/en/trade");
        }
    }

    // ‡ß´. ‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶°
    function showSettingsModal() {
        // Check if modal is already open - prevent duplicate modals
        const existingOverlay = document.getElementById('qx-settings-overlay');
        if (existingOverlay) {
            return; // Modal already open, don't create another one
        }
        
        // Get current values from localStorage
        const currentLBName = localStorage.getItem(lbNameKey) || "Siam";
        const currentLBBalance = parseFloat(localStorage.getItem(lbProfitKey)) || 0;
        
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'qx-settings-modal-overlay';
        overlay.id = 'qx-settings-overlay';
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'qx-settings-modal';
        
        modal.innerHTML = `
            <div class="qx-settings-modal-header">ùëªùëπùë®ùë´ùë¨ùëπ DYABLE</div>
            
            <div class="qx-settings-form-group">
                <label class="qx-settings-label">Leaderboard Name</label>
                <input type="text" 
                       id="qx-lb-name-input" 
                       class="qx-settings-input" 
                       placeholder="Enter name"
                       value="${currentLBName}">
            </div>
            
            <div class="qx-settings-form-group">
                <label class="qx-settings-label">Leaderboard Balance</label>
                <input type="number" 
                       id="qx-lb-balance-input" 
                       class="qx-settings-input" 
                       placeholder="Enter balance"
                       value="${currentLBBalance}"
                       step="0.01">
            </div>
            
            <div class="qx-settings-form-group">
                <label class="qx-settings-label">Demo Account Balance</label>
                <input type="number" 
                       id="qx-demo-balance-input" 
                       class="qx-settings-input" 
                       placeholder="Enter demo balance"
                       value="${customDemoBalance}"
                       step="0.01">
            </div>
            
            <a href="t.me/Dyablenoir55" target="_blank" class="qx-telegram-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.13-.31-1.09-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z" fill="currentColor"/>
                </svg>
                <span>Message on Telegram</span>
            </a>
            
            <div class="qx-settings-buttons">
                <button class="qx-settings-btn qx-settings-btn-cancel" id="qx-modal-cancel">Cancel</button>
                <button class="qx-settings-btn qx-settings-btn-save" id="qx-modal-save">Save</button>
            </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Focus on first input
        setTimeout(() => {
            const nameInput = document.getElementById('qx-lb-name-input');
            if (nameInput) nameInput.focus();
        }, 100);
        
        // Close on overlay click
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                closeModal();
            }
        });
        
        // Close on Cancel button
        document.getElementById('qx-modal-cancel').addEventListener('click', closeModal);
        
        // Save on Save button
        document.getElementById('qx-modal-save').addEventListener('click', function() {
            const nameInput = document.getElementById('qx-lb-name-input');
            const balanceInput = document.getElementById('qx-lb-balance-input');
            const demoBalanceInput = document.getElementById('qx-demo-balance-input');
            
            const newName = nameInput.value.trim() || "Siam";
            const newBalance = parseFloat(balanceInput.value) || 0;
            const newDemoBalance = parseFloat(demoBalanceInput.value) || 10000;
            
            // Save to localStorage
            localStorage.setItem(lbNameKey, newName);
            localStorage.setItem(lbProfitKey, newBalance.toFixed(2));
            customDemoBalance = newDemoBalance;
            
            // Update UI
            applySpoof();
            if (typeof syncAll === 'function') {
                syncAll();
            }
            
            closeModal();
        });
        
        // Close on Escape key
        const escapeHandler = function(e) {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', escapeHandler);
            }
        };
        document.addEventListener('keydown', escapeHandler);
        
        function closeModal() {
            overlay.classList.add('closing');
            modal.classList.add('closing');
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            }, 200);
        }
    }
    
    // Deposit button detection - ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ Deposit button-‡¶è click ‡¶ï‡¶∞‡¶≤‡ßá‡¶á modal open ‡¶π‡¶¨‡ßá
    function isDepositButton(element) {
        if (!element) return false;
        
        // Check if element is a button or link
        const tagName = element.tagName?.toLowerCase();
        if (tagName !== 'button' && tagName !== 'a') return false;
        
        // Get text content (trimmed and case-insensitive)
        const text = (element.textContent || '').trim().toLowerCase();
        const innerText = (element.innerText || '').trim().toLowerCase();
        
        // Check if text contains "deposit" (exact match or contains)
        if (text === 'deposit' || text.includes('deposit')) return true;
        if (innerText === 'deposit' || innerText.includes('deposit')) return true;
        
        // Check href for deposit links
        if (tagName === 'a' && element.href) {
            const href = element.href.toLowerCase();
            if (href.includes('/deposit') || href.includes('deposit')) return true;
        }
        
        // Check data attributes or classes that might indicate deposit button
        const className = (element.className || '').toLowerCase();
        const id = (element.id || '').toLowerCase();
        if (className.includes('deposit') || id.includes('deposit')) return true;
        
        return false;
    }
    
    // Deposit button click handler - ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ Deposit button-‡¶è click ‡¶ï‡¶∞‡¶≤‡ßá‡¶á modal open ‡¶π‡¶¨‡ßá
    document.addEventListener('click', function(e) {
        // Check if clicked element is a deposit button
        const clickedElement = e.target;
        const closestButton = clickedElement.closest('button, a');
        
        // Check if the clicked element or its closest button/link is a deposit button
        if (isDepositButton(clickedElement) || (closestButton && isDepositButton(closestButton))) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            // Prevent default behavior and open modal
            showSettingsModal();
            return false;
        }
    }, true);

    // ‡ß¨. ‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡ßç‡¶™‡ßÅ‡¶´‡¶ø‡¶Ç ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function applySpoof() {
        maskUI();

        // ‡¶Æ‡ßá‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶æ‡¶≤ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶®‡ßá‡¶ì‡ßü‡¶æ (‡¶Ø‡¶æ‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá‡¶∞‡¶ü‡¶æ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡ßá)
        const mainBalanceEl = document.querySelector(selectors.usermenuBalance);
        const currentMainVal = numFromText(mainBalanceEl?.textContent);
        const mainAmountStr = formatAmount(currentMainVal);
        const customDemoStr = formatAmount(customDemoBalance);

        // --- ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ---
        const nameEl = document.querySelector(selectors.usermenuName);
        if (nameEl && nameEl.textContent !== targetName) {
            nameEl.textContent = targetName;
            nameEl.style.color = "";
        }

        // ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ)
        const listItems = document.querySelectorAll(selectors.usermenuListItems);
        if (listItems.length > 0) {
            listItems.forEach(li => {
                const text = li.innerText;
                
                // ‡¶Ø‡¶¶‡¶ø "Demo Account" ‡¶≤‡¶ø‡¶ñ‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶¨‡¶∏‡¶¨‡ßá
                if (text.includes("Demo Account")) {
                    const bTag = li.querySelector("b");
                    if (bTag && bTag.textContent !== customDemoStr) bTag.textContent = customDemoStr;
                    
                    if (li.classList.contains(activeClass)) {
                        li.classList.remove(activeClass);
                    }
                } 
                // ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá ‡¶Æ‡ßá‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
                else if (text.includes("Live")) {
                    const bTag = li.querySelector("b");
                    if (bTag && bTag.textContent !== mainAmountStr) bTag.textContent = mainAmountStr;

                    if (!li.classList.contains(activeClass)) {
                        li.classList.add(activeClass);
                    }
                }
            });
        }

        // ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶ì ‡¶Ü‡¶á‡¶ï‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶Æ‡ßá‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
        let level = 'standart';
        let profit = '+0% profit';
        if (currentMainVal > 9999.99) { level = 'vip'; profit = '+4% profit'; }
        else if (currentMainVal > 4999.99) { level = 'pro'; profit = '+2% profit'; }

        const iconHref = `/profile/images/spritemap.svg#icon-profile-level-${level}`;
        [selectors.usermenuIconUse, selectors.levelIcon].forEach(sel => {
            const el = document.querySelector(sel);
            if (el && el.getAttribute("xlink:href") !== iconHref) {
                el.setAttribute("xlink:href", iconHref);
            }
        });

        const lName = document.querySelector(selectors.levelName);
        const lProfit = document.querySelector(selectors.levelProfit);
        if (lName && lName.textContent !== level + ":") lName.textContent = level + ":";
        if (lProfit && lProfit.textContent !== profit) lProfit.textContent = profit;
    }

    // ‡ß≠. ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶Ö‡¶™‡ßç‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡¶° ‡¶≤‡ßÅ‡¶™ (Throttle)
    let isLocked = false;
    const updateHandler = () => {
        if (isLocked) return;
        isLocked = true;
        requestAnimationFrame(() => {
            applySpoof();
            isLocked = false;
        });
    };

    const observer = new MutationObserver(updateHandler);
    observer.observe(document.documentElement, {
        childList: true,
        subtree: true,
        attributes: false 
    });

    // ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤ ‡¶∞‡¶æ‡¶®
    applySpoof();
    setInterval(applySpoof, 1000);

    // ============================================
    // Leaderboard Function (Connected)
    // ============================================
    
    const FIXED_ROW_AMOUNT = 30000; // base number

    const lbSelectors = {
        usermenuBalance: ".---react-features-Usermenu-styles-module__infoBalance--pVBHU",
        lbPositionMoney: ".---react-features-Sidepanel-LeaderBoard-Position-styles-module__money--BwWCZ",
        lbPositionName: ".---react-features-Sidepanel-LeaderBoard-Position-styles-module__name--xN5cX",
        lbPositionRank: ".---react-features-Sidepanel-LeaderBoard-Position-styles-module__footer--iKtL6",
        lbLineTrack: ".---react-features-Sidepanel-LeaderBoard-Position-styles-module__expand--KBHoM",
        lbRowItem: ".---react-features-Sidepanel-LeaderBoard-styles-module__item--8FRDh",
        lbRowName: ".---react-features-Sidepanel-LeaderBoard-styles-module__name--MrPOZ",
        lbRowMoney: ".---react-features-Sidepanel-LeaderBoard-styles-module__money--jJUGd",
        lbAvatar: ".---react-features-Sidepanel-LeaderBoard-styles-module__avatar--ZVpcN",
        lbTopAvatar: ".---react-features-Sidepanel-LeaderBoard-Position-styles-module__avatar--V7kWb"
    };

    const points = [
        { profit:-1000000, position:2000000 },
        { profit:-500000,  position:1000000 },
        { profit:-200000,  position:500000 },
        { profit:-100000,  position:50000000 },
        { profit:-50000,   position:30000000 },
        { profit:-40000,   position:25000000 },
        { profit:-35000,   position:20000000 },
        { profit:-30000,   position:15000000 },
        { profit:-20000,   position:10000000 },
        { profit:-10000,   position:5000000 },
        { profit:-7000,    position:9000000 },
        { profit:-5000,    position:8000000 },
        { profit:-4000,    position:7500000 },
        { profit:-3000,    position:7000000 },
        { profit:-2000,    position:6500000 },
        { profit:-1000,    position:6000000 },
        { profit:-800,     position:78000 },
        { profit:-650,     position:75000 },
        { profit:-500,     position:70000 },
        { profit:-400,     position:68000 },
        { profit:-300,     position:65000 },
        { profit:-250,     position:62000 },
        { profit:-200,     position:60000 },
        { profit:-150,     position:58000 },
        { profit:-100,     position:55000 },
        { profit:-75,      position:53000 },
        { profit:-50,      position:50000 },
        { profit:-25,      position:48000 },
        { profit:0,        position:150000 },
        { profit:1,        position:140000 },
        { profit:2,        position:130000 },
        { profit:3,        position:120000 },
        { profit:4,        position:115000 },
        { profit:5,        position:110000 },
        { profit:10,       position:100000 },
        { profit:20,       position:90000 },
        { profit:50,       position:5000 },
        { profit:75,       position:3000 },
        { profit:80,       position:8750 },
        { profit:100,       position:10000 },
        { profit:150,       position:7500 },
        { profit:200,      position:6250 },
        { profit:300,      position:5000 },
        { profit:400,      position:800 },
        { profit:500,      position:1250 },
        { profit:550,      position:1200 },
        { profit:577,      position:1250 },
        { profit:600,      position:1300 },
        { profit:700,      position:400 },
        { profit:800,      position:300 },
        { profit:1000,     position:200 },
        { profit:1500,     position:150 },
        { profit:2000,     position:120 },
        { profit:3000,     position:100 },
        { profit:4000,     position:80 },
        { profit:5000,     position:60 },
        { profit:5500,     position:50 },
        { profit:6000,     position:40 },
        { profit:7000,     position:20 },
        { profit:7500,     position:18 },
        { profit:7888,     position:12 },
        { profit:8000,     position:12 },
        { profit:8235,     position:11 },
        { profit:8500,     position:11 },
        { profit:9000,     position:10 },
        { profit:9012,     position:10 },
        { profit:9500,     position:9 },
        { profit:9577,     position:9 },
        { profit:10000,    position:8 },
        { profit:10398,    position:8 },
        { profit:10860,    position:7 },
        { profit:11000,    position:7 },
        { profit:12000,    position:6 },
        { profit:12924,    position:6 },
        { profit:12938,    position:5 },
        { profit:13000,    position:5 },
        { profit:13333,    position:4 },
        { profit:14000,    position:4 },
        { profit:15000,    position:4 },
        { profit:18000,    position:3 },
        { profit:20000,    position:3 },
        { profit:24000,    position:3 },
        { profit:25000,    position:3 },
        { profit:27000,    position:2 },
        { profit:29000,    position:2 },
        { profit:29500,    position:2 },
        { profit:29800,    position:1 },
        { profit:29900,    position:1 },
        { profit:30000,    position:1 }
    ];

    let initialBalance=null,isUpdating=false;
    const $=s=>document.querySelector(s);
    const $$=s=>[...document.querySelectorAll(s)];

    function formatAmountLB(n){
        const f=Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        return n<0?`-$${f}`:`$${f}`;
    }

    function calculateDynamicRank(profit){
        const sorted=[...points].sort((a,b)=>a.profit-b.profit);
        if(profit<=sorted[0].profit) return sorted[0].position;
        if(profit>=sorted.at(-1).profit) return sorted.at(-1).position;
        for(let i=0;i<sorted.length-1;i++){
            const p1=sorted[i],p2=sorted[i+1];
            if(profit>=p1.profit && profit<=p2.profit){
                const r=(profit-p1.profit)/(p2.profit-p1.profit);
                return Math.round(p1.position+r*(p2.position-p1.position));
            }
        }
        return 25000;
    }

    // Helper function to parse money from text
    function parseMoney(text) {
        return parseFloat(text.replace(/[^0-9.-]+/g, '')) || 0;
    }

    // Helper function to extract rank number from leaderboard row
    function getRowRank(row) {
        if (!row) return null;
        
        // Method 1: Check first child element (rank is usually first)
        const firstChild = row.firstElementChild;
        if (firstChild) {
            const firstText = firstChild.textContent?.trim() || '';
            const rankMatch = firstText.match(/^(\d+)$/);
            if (rankMatch) {
                const num = parseInt(rankMatch[1]);
                // Only return if rank is 1-20
                if (num >= 1 && num <= 20) {
                    return num;
                }
            }
        }
        
        // Method 2: Check all direct children for numeric content
        const children = Array.from(row.children);
        for (let i = 0; i < children.length; i++) {
            const childText = (children[i].textContent || '').trim();
            const rankMatch = childText.match(/^(\d+)$/);
            if (rankMatch) {
                const num = parseInt(rankMatch[1]);
                // Only return if rank is 1-20
                if (num >= 1 && num <= 20) {
                    return num;
                }
            }
        }
        
        // Method 3: Parse from row text content (fallback)
        const rowText = row.textContent || '';
        const rankMatch = rowText.match(/^(\d+)/);
        if (rankMatch) {
            const num = parseInt(rankMatch[1]);
            // Only return if rank is 1-20
            if (num >= 1 && num <= 20) {
                return num;
            }
        }
        
        return null;
    }

    // Calculate position based on actual leaderboard rows (only for 1-20 positions)
    function calculatePositionFromLeaderboard(userProfit, rows) {
        if (!rows || rows.length === 0) {
            return calculateDynamicRank(userProfit);
        }
        
        // Get all profits from leaderboard rows with their ranks (only 1-20)
        const rowData = [];
        for (let i = 0; i < rows.length; i++) {
            const moneyEl = rows[i].querySelector(lbSelectors.lbRowMoney);
            if (moneyEl) {
                const profit = parseMoney(moneyEl.textContent);
                const rank = getRowRank(rows[i]);
                // Only consider ranks 1-20
                if (rank !== null && rank >= 1 && rank <= 20 && !isNaN(profit) && profit > 0) {
                    rowData.push({ rank, profit, index: i });
                }
            }
        }
        
        if (rowData.length === 0) {
            return calculateDynamicRank(userProfit);
        }
        
        // Sort by profit descending (highest profit first)
        rowData.sort((a, b) => b.profit - a.profit);
        
        const highestProfit = rowData[0].profit;
        const lowestProfit = rowData[rowData.length - 1].profit;
        const highestRank = rowData[0].rank;
        const lowestRank = rowData[rowData.length - 1].rank;
        
        // If user profit is higher than highest visible profit, calculate position above (1-20 only)
        if (userProfit > highestProfit) {
            // User should be above the highest visible rank
            if (highestRank <= 10 && highestRank >= 1) {
                // If top visible is rank 1-10, user is likely rank 1
                return 1;
            } else if (highestRank > 10 && highestRank <= 20) {
                // User is above visible range but within 1-20
                return Math.max(1, highestRank - 1);
            } else {
                // Fallback to calculated rank
                return calculateDynamicRank(userProfit);
            }
        }
        
        // If user profit is lower than lowest visible profit, use interpolated or below
        if (userProfit < lowestProfit) {
            // User is below visible range, use interpolated position
            return calculateDynamicRank(userProfit);
        }
        
        // User profit is within visible range (1-20), find exact position
        for (let i = 0; i < rowData.length; i++) {
            if (userProfit >= rowData[i].profit) {
                // User's profit is >= this row's profit
                // User should be at this row's rank or better (within 1-20)
                return rowData[i].rank;
            }
        }
        
        // Fallback: user is below all visible (within 1-20)
        if (lowestRank < 20) {
            return Math.min(20, lowestRank + 1);
        }
        return calculateDynamicRank(userProfit);
    }

    // no animation on green line + position rank styling
    const lbStyle=document.createElement('style');
    lbStyle.innerHTML=`
        ${lbSelectors.lbLineTrack}{background:#0faf59!important;height:2px!important;transition:none!important}
        ${lbSelectors.lbPositionRank}{color:#a0a0a0!important;white-space:pre!important}
        ${lbSelectors.lbPositionRank} b{color:#ffffff!important;margin-left:4px!important;font-weight:600!important}
    `;
    document.head ? document.head.appendChild(lbStyle) : document.documentElement.appendChild(lbStyle);

    function syncAll(){
        if(isUpdating) return; isUpdating=true;

        let profit=parseFloat(localStorage.getItem(lbProfitKey))||0;
        let name=localStorage.getItem(lbNameKey)||"Siam";

        // Check if leaderboard balance input field exists and has value (from settings modal)
        // Priority: Input field value > localStorage value > balance sync
        const lbBalanceInput = document.getElementById('qx-lb-balance-input');
        if(lbBalanceInput && lbBalanceInput.value !== '' && !isNaN(parseFloat(lbBalanceInput.value))){
            // Use value directly from input field (highest priority)
            profit = parseFloat(lbBalanceInput.value) || 0;
            localStorage.setItem(lbProfitKey, profit.toFixed(2));
        } else {
            // Use localStorage value (from settings modal save)
            profit = parseFloat(localStorage.getItem(lbProfitKey)) || 0;
            
            // balance sync (only if no manual input)
            const header=$(lbSelectors.usermenuBalance);
            if(header){
                const cur=parseFloat(header.textContent.replace(/[^0-9.-]/g,""));
                if(initialBalance===null) initialBalance=cur;
                const diff=cur-initialBalance;
                if(Math.abs(diff)>0.01){
                    profit+=diff;
                    initialBalance=cur;
                    localStorage.setItem(lbProfitKey,profit.toFixed(2));
                }
            }
        }

        // progress line - based on percentage profit of balance
        const line=$(lbSelectors.lbLineTrack);
        if(line){
            let w=50; // default 50%
            
            // Get current balance to calculate percentage
            const header=$(lbSelectors.usermenuBalance);
            if(header && profit > 0){
                const currentBalance=parseFloat(header.textContent.replace(/[^0-9.-]/g,"")) || 0;
                if(currentBalance > 0){
                    const profitPercent = (profit / currentBalance) * 100;
                    
                    // Calculate green line width based on profit percentage
                    if(profitPercent >= 5 && profitPercent < 10){
                        // 5-10% profit ‚Üí 60-65% green line
                        const ratio = (profitPercent - 5) / (10 - 5);
                        w = 60 + (ratio * 5); // 60 to 65
                    } else if(profitPercent >= 10 && profitPercent < 30){
                        // 10-30% profit ‚Üí 65-70% green line
                        const ratio = (profitPercent - 10) / (30 - 10);
                        w = 65 + (ratio * 5); // 65 to 70
                    } else if(profitPercent >= 30 && profitPercent < 40){
                        // 30-40% profit ‚Üí 70-75% green line
                        const ratio = (profitPercent - 30) / (40 - 30);
                        w = 70 + (ratio * 5); // 70 to 75
                    } else if(profitPercent >= 40 && profitPercent < 50){
                        // 40-50% profit ‚Üí 80-85% green line
                        const ratio = (profitPercent - 40) / (50 - 40);
                        w = 80 + (ratio * 5); // 80 to 85
                    } else if(profitPercent >= 50 && profitPercent < 70){
                        // 50-70% profit ‚Üí 85-95% green line
                        const ratio = (profitPercent - 50) / (70 - 50);
                        w = 85 + (ratio * 10); // 85 to 95
                    } else if(profitPercent >= 70 || profitPercent >= 82){
                        // 70%+ or 82%+ profit ‚Üí 100% green line
                        w = 100;
                    } else if(profitPercent > 0 && profitPercent < 5){
                        // 0-5% profit ‚Üí 50-60% green line
                        const ratio = profitPercent / 5;
                        w = 50 + (ratio * 10); // 50 to 60
                    }
                }
            } else if(profit < 0 && header){
                // Loss ‚Üí calculate based on loss percentage of balance
                const currentBalance=parseFloat(header.textContent.replace(/[^0-9.-]/g,"")) || 0;
                if(currentBalance > 0){
                    // Calculate loss percentage (profit is negative, so we use absolute value)
                    const lossAmount = Math.abs(profit);
                    const lossPercent = (lossAmount / currentBalance) * 100;
                    
                    // Calculate green line width based on loss percentage
                    if(lossPercent >= 10 && lossPercent < 20){
                        // 10-20% loss ‚Üí 50-30% green line
                        const ratio = (lossPercent - 10) / (20 - 10);
                        w = 50 - (ratio * 20); // 50 to 30
                    } else if(lossPercent >= 20 && lossPercent < 40){
                        // 20-40% loss ‚Üí 30-15% green line
                        const ratio = (lossPercent - 20) / (40 - 20);
                        w = 30 - (ratio * 15); // 30 to 15
                    } else if(lossPercent >= 40 && lossPercent < 50){
                        // 40-50% loss ‚Üí 15-5% green line
                        const ratio = (lossPercent - 40) / (50 - 40);
                        w = 15 - (ratio * 10); // 15 to 5
                    } else if(lossPercent >= 50 && lossPercent < 100){
                        // 50-100% loss ‚Üí 5-2% green line
                        const ratio = (lossPercent - 50) / (100 - 50);
                        w = 5 - (ratio * 3); // 5 to 2
                    } else if(lossPercent >= 100){
                        // Full balance loss (100%+) ‚Üí 2-3% green line
                        w = Math.max(2, Math.min(3, 2 + (lossPercent - 100) / 100));
                    } else if(lossPercent > 0 && lossPercent < 10){
                        // 0-10% loss ‚Üí 50% green line (gradual decrease)
                        const ratio = lossPercent / 10;
                        w = 50 - (ratio * 0); // Stay at 50% for small losses
                    }
                } else {
                    // If no balance, use old method
                    w = Math.max(2, 50 - (Math.abs(profit) / 200));
                }
            } else if(profit < 0){
                // Fallback for loss without balance
                w = Math.max(2, 50 - (Math.abs(profit) / 200));
            }
            
            w = Math.min(100, Math.max(2, w)); // Ensure between 2-100%
            line.style.width=w+'%';
        }

        // rank - use leaderboard rows for 1-20 positions, otherwise use calculated rank
        let rank;
        const leaderboardRows=$$(lbSelectors.lbRowItem);
        // Only use leaderboard-based calculation if we have rows and profit is positive (likely in 1-20 range)
        if(leaderboardRows.length > 0 && profit > 0){
            const calculatedFromLB = calculatePositionFromLeaderboard(profit, leaderboardRows);
            // Only use leaderboard-based position if it's within 1-20 range
            if(calculatedFromLB >= 1 && calculatedFromLB <= 20){
                rank = calculatedFromLB;
            } else {
                rank = calculateDynamicRank(profit);
            }
        } else {
            rank = calculateDynamicRank(profit);
        }
        
        const footer=$(lbSelectors.lbPositionRank);
        if(footer) {
            // Format position: adjust division factor to keep max 6 digits
            let formattedRank;
            
            if(profit < 0){
                // For loss: divide by larger factor to keep within 6 digits
                // If rank is very large, divide more to keep it reasonable
                if(rank >= 1000000){
                    formattedRank = Math.floor(rank / 100); // Divide by 100 for very large ranks
                } else if(rank >= 100000){
                    formattedRank = Math.floor(rank / 50); // Divide by 50 for large ranks
                } else {
                    formattedRank = Math.floor(rank / 10); // Divide by 10 for smaller ranks
                }
                
                // Ensure it's a round number ending in 0 or 5
                const lastDigit = formattedRank % 10;
                if(lastDigit !== 0 && lastDigit !== 5){
                    formattedRank = Math.round(formattedRank / 10) * 10;
                }
            } else {
                // For profit: if rank is 1-20, show directly without division
                if(rank >= 1 && rank <= 20){
                    formattedRank = rank;
                } else {
                    // For ranks above 20, divide by 5 (keep more digits)
                    formattedRank = Math.floor(rank / 5);
                    
                    // Ensure even number for profit (make it professional)
                    if(formattedRank % 2 !== 0){
                        formattedRank = formattedRank + 1;
                    }
                }
            }
            
            // Ensure maximum 6 digits (999999)
            if(formattedRank > 999999){
                formattedRank = 999999;
            }
            
            // Add proper spacing between "Your position:" and the number (with space after colon)
            footer.innerHTML=`Your position: <b>${formattedRank}</b>`;
            footer.style.color="#a0a0a0";
            // Set bold tag (number) color to white
            const boldTag = footer.querySelector('b');
            if(boldTag) {
                boldTag.style.color="#ffffff";
                boldTag.style.fontWeight="600";
            }
        }

        // ü•á Top card = real (profit/loss based color) - always update
        const moneyEl=$(lbSelectors.lbPositionMoney);
        if(moneyEl){
            moneyEl.textContent=formatAmountLB(profit);
            // Set color based on profit/loss with !important to prevent override
            // Ensure profit is a number and check strictly
            const profitNum = Number(profit);
            if(!isNaN(profitNum) && profitNum > 0){
                moneyEl.style.setProperty('color', '#0faf59', 'important'); // Green for profit
            } else if(!isNaN(profitNum) && profitNum < 0){
                moneyEl.style.setProperty('color', '#ff4444', 'important'); // Red for loss
            } else {
                moneyEl.style.setProperty('color', '', 'important'); // Default for zero
            }
        }

        const nameEl=$(lbSelectors.lbPositionName);
        if(nameEl) {
            // Update name properly - replace all text nodes
            nameEl.childNodes.forEach(n=>{
                if(n.nodeType===3){
                    n.textContent=" "+name;
                }
            });
            // Also set innerText as fallback
            if(nameEl.textContent.trim() !== name.trim()){
                nameEl.innerHTML = name;
            }
        }

        // üìã Row = $30,000.00+ (profit/loss based color) - only update if rank is within leaderboard range
        const rows=$$(lbSelectors.lbRowItem);
        // Check if rank is within visible leaderboard range (1 to rows.length)
        const hasEntry = rows.length > 0 && rank > 0 && rank <= rows.length;
        
        if(hasEntry && rows.length > 0){
            // Calculate index: rank is 1-based, array is 0-based, so rank-1
            // But ensure it's within bounds
            const index=Math.max(0,Math.min(rows.length-1,rank-1));
            const myRow=rows[index];
            if(myRow){
                const rName=myRow.querySelector(lbSelectors.lbRowName);
                const rMoney=myRow.querySelector(lbSelectors.lbRowMoney);
                const rAvatar=myRow.querySelector(lbSelectors.lbAvatar);

                // Update name - ensure it's set properly
                if(rName) {
                    rName.textContent=name;
                    // Force update
                    if(rName.textContent !== name){
                        rName.innerHTML = name;
                    }
                }
                
                if(rMoney){
                    // Show actual profit instead of fixed amount
                    rMoney.textContent=formatAmountLB(profit);
                    // Set color based on profit/loss with !important to prevent override
                    // Ensure profit is a number and check strictly
                    const profitNum = Number(profit);
                    if(!isNaN(profitNum) && profitNum > 0){
                        rMoney.style.setProperty('color', '#0faf59', 'important'); // Green for profit
                    } else if(!isNaN(profitNum) && profitNum < 0){
                        rMoney.style.setProperty('color', '#ff4444', 'important'); // Red for loss
                    } else {
                        rMoney.style.setProperty('color', '', 'important'); // Default for zero
                    }
                }

                // Force default avatar in leaderboard row (like sadsarewr.js)
                if(rAvatar){
                    rAvatar.innerHTML = `<svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg>`;
                }

                // Update top avatar based on rank - get rank badge from corresponding leaderboard row (like sadsarewr.js)
                const topAvatar=$(lbSelectors.lbTopAvatar);
                if(topAvatar){
                    // For rank 1-20, get rank badge (yellow circle with number) from the corresponding leaderboard row
                    if(rank >= 1 && rank <= 20 && rows.length >= rank){
                        // Get the row at this rank (rank 1 = index 0, rank 2 = index 1, etc.)
                        const rankRowIndex = rank - 1; // Convert to 0-based index
                        const rankRow = rows[rankRowIndex];
                        if(rankRow){
                            // Get the first child element which is usually the rank badge (yellow circle with number)
                            // This is the rank badge, not the main icon/logo
                            const rankBadge = rankRow.firstElementChild;
                            if(rankBadge){
                                // Check if it's actually a rank badge (contains number or has badge-like structure)
                                const badgeText = rankBadge.textContent?.trim() || '';
                                const hasRankNumber = /^\d+$/.test(badgeText) || rankBadge.querySelector('span, div')?.textContent?.trim().match(/^\d+$/);
                                
                                if(hasRankNumber || rankBadge.classList.toString().includes('badge') || rankBadge.classList.toString().includes('rank')){
                                    // Clone the rank badge (yellow circle with number) to top avatar
                                    topAvatar.innerHTML = "";
                                    topAvatar.appendChild(rankBadge.cloneNode(true));
                                } else {
                                    // If first child is not rank badge, try to find it
                                    const badgeElement = rankRow.querySelector('div[class*="badge"], div[class*="rank"], [class*="circle"]');
                                    if(badgeElement){
                                        topAvatar.innerHTML = "";
                                        topAvatar.appendChild(badgeElement.cloneNode(true));
                                    } else {
                                        // Fallback to default icon
                                        topAvatar.innerHTML = `<svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg>`;
                                    }
                                }
                            } else {
                                // Fallback: try to find rank badge by looking for circle or badge element
                                const badgeElement = rankRow.querySelector('div[class*="badge"], div[class*="rank"], [class*="circle"]');
                                if(badgeElement){
                                    topAvatar.innerHTML = "";
                                    topAvatar.appendChild(badgeElement.cloneNode(true));
                                } else {
                                    // Fallback to default icon
                                    topAvatar.innerHTML = `<svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg>`;
                                }
                            }
                        } else {
                            // Fallback to default icon
                            topAvatar.innerHTML = `<svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg>`;
                        }
                    } else {
                        // For rank > 20, use default icon
                        topAvatar.innerHTML = `<svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg>`;
                    }
                }
            }
        }

        isUpdating=false;
    }

    new MutationObserver(()=>requestAnimationFrame(syncAll)).observe(document.body,{childList:true,subtree:true});
    setInterval(syncAll,500);

})();

//DEMO FILIP
/* ======================================================
   üîí LIVE TICK HARD LOCK (KEEP PEN + REFRESH ICONS)
   ====================================================== */

const ACTIVE = '---react-features-Usermenu-Dropdown-styles-module__active--P5n2A';

/**
 * üîç Check icon detector
 * Only targets the BLUE CIRCLE CHECK (‚úîÔ∏è)
 * Does NOT touch pen / refresh icons
 */
function isCheckIcon(svg) {
    if (!svg) return false;

    // common patterns used by QX for selected account
    const use = svg.querySelector("use");
    const href = use?.getAttribute("xlink:href") || "";

    return (
        href.includes("check") ||
        href.includes("selected") ||
        svg.getAttribute("aria-checked") === "true"
    );
}

function lockLiveAccountOnly() {
    const lis = document.querySelectorAll("li");
    let liveLi = null;
    let demoLi = null;

    lis.forEach(li => {
        const t = (li.textContent || "").toLowerCase();
        if (t.includes("live")) liveLi = li;
        if (t.includes("demo")) demoLi = li;
    });

    if (!liveLi) return;

    /* ‚ùå DEMO: remove ONLY check tick */
    if (demoLi) {
        demoLi.classList.remove(ACTIVE);

        demoLi.querySelectorAll("svg").forEach(svg => {
            if (isCheckIcon(svg)) {
                svg.remove(); // ‚ùå only tick
            }
        });
    }

    /* ‚úÖ LIVE: always active */
    liveLi.classList.add(ACTIVE);

    // safety: nowhere else active
    lis.forEach(li => {
        if (li !== liveLi) li.classList.remove(ACTIVE);
    });
}

/* ======================================================
   üß† REACT-LEVEL PROTECTION (NO FLICKER)
   ====================================================== */
(function hijackActiveClass() {
    const originalAdd = DOMTokenList.prototype.add;
    DOMTokenList.prototype.add = function (...args) {
        try {
            if (args.includes(ACTIVE)) {
                const li = this.ownerElement?.closest("li");
                if (li && !li.textContent.toLowerCase().includes("live")) {
                    return; // ‚ùå block demo instantly
                }
            }
        } catch (e) {}
        return originalAdd.apply(this, args);
    };
})();

/* ======================================================
   üîÅ ENFORCEMENT
   ====================================================== */

// every frame (no 1ms flicker possible)
setInterval(lockLiveAccountOnly, 16);

// any DOM / React update
new MutationObserver(lockLiveAccountOnly)
    .observe(document.body, { childList: true, subtree: true });

// lifecycle
document.addEventListener("DOMContentLoaded", lockLiveAccountOnly);
window.addEventListener("load", lockLiveAccountOnly);

//70%
(function () {
    const hideBanner = () => {
        document.querySelectorAll('div[class*="react-features-Banner-styles-module__banner"]')
            .forEach(el => {
                // Instead of removing, just hide safely
                el.style.display = "none";
                el.style.visibility = "hidden";
                el.style.opacity = "0";
            });
    };

    const observer = new MutationObserver(() => {
        hideBanner();
    });

    observer.observe(document.documentElement, {
        childList: true,
        subtree: true
    });

    hideBanner();
})();

(function () {
    if (window.__demoTxScriptLoaded) return;
    window.__demoTxScriptLoaded = true;
  
    // Keys
    const STORAGE_KEY = "demo_transactions_list";
    const HIDE_WEBSITE_TXS_KEY = "demo_transactions_hide_website_transactions";
    const SHOW_ROW_ACTIONS_KEY = "demo_transactions_show_row_actions"; // ‚úÖ NEW
  
    // Storage wrapper (chrome.storage.local if available)
    const storage = {
      async get(key, fallback) {
        if (typeof chrome !== "undefined" && chrome.storage && chrome.storage.local) {
          return new Promise((resolve) => {
            chrome.storage.local.get({ [key]: fallback }, (res) => resolve(res[key]));
          });
        } else {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
          } catch (e) {
            return fallback;
          }
        }
      },
      async set(key, value) {
        if (typeof chrome !== "undefined" && chrome.storage && chrome.storage.local) {
          return new Promise((resolve) => {
            chrome.storage.local.set({ [key]: value }, () => resolve());
          });
        } else {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch (e) { /* ignore */ }
        }
      }
    };
  
    // Transaction helpers
    async function saveTransactions(arr) { await storage.set(STORAGE_KEY, arr || []); }
    async function loadTransactions() { return await storage.get(STORAGE_KEY, []); }
    async function pushTransaction(tx) {
      const arr = await loadTransactions();
      arr.unshift(tx);
      await saveTransactions(arr);
    }
    async function updateTransaction(order, newData) {
      let arr = await loadTransactions();
      arr = arr.map(tx => tx.order === order ? newData : tx);
      await saveTransactions(arr);
    }
    async function deleteTransaction(order) {
      let arr = await loadTransactions();
      arr = arr.filter(tx => tx.order !== order);
      await saveTransactions(arr);
    }
    async function deleteAllTransactions() { await saveTransactions([]); }
  
    async function saveHiddenOrders(arr) { await storage.set(HIDE_WEBSITE_TXS_KEY, arr || []); }
    async function loadHiddenOrders() { return await storage.get(HIDE_WEBSITE_TXS_KEY, []); }

    // ‚úÖ Show actions toggle
    async function saveShowActions(val) { await storage.set(SHOW_ROW_ACTIONS_KEY, !!val); }
    async function loadShowActions() { return await storage.get(SHOW_ROW_ACTIONS_KEY, true); }
  
    // Utilities
    function formatCustomDate(dateInput) {
      if (!dateInput) return "";
      const d = new Date(dateInput);
      if (isNaN(d)) return "";
      const pad = (n) => (n < 10 ? "0" + n : n);
      return pad(d.getDate()) + "/" +
        pad(d.getMonth() + 1) + "/" +
        d.getFullYear() + ", " +
        pad(d.getHours()) + ":" +
        pad(d.getMinutes()) + ":" +
        pad(d.getSeconds());
    }
  
    function toDatetimeLocalValue(date) {
      const d = date instanceof Date ? date : new Date(date);
      if (isNaN(d)) return "";
      const pad = (n) => (n < 10 ? "0" + n : n);
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
  
    function formatNumberWithCommas(num) {
      // Convert to string and split by decimal point
      const parts = num.toString().split(".");
      // Add commas to integer part
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      // Return with decimal part if exists
      return parts.join(".");
    }

    function formatAmount(type, value) {
      if (value === undefined || value === null) return "";
      let clean = String(value).replace(/[^\d.\-]/g, "");
      let num = parseFloat(clean);
      if (isNaN(num)) return "";

      // Format number with commas
      const formattedNum = formatNumberWithCommas(Math.abs(num).toFixed(2));

      if (type === "Payout") {
        if (num > 0) num = -num;
        return "-" + "$" + formattedNum;
      } else {
        if (num < 0) num = Math.abs(num);
        return "+" + "$" + formattedNum;
      }
    }
  
    function generateRandomTransactionId(length) {
      let str = "";
      for (let i = 0; i < length; i++) str += Math.floor(Math.random() * 10);
      return str;
    }
  
    // UI / state
    let panel = null;
    let editOrderId = null;
    let domObserverStarted = false;
  
    // ‚úÖ Colors
    const AMOUNT_GREEN = "#00c85a";
    const MAIN_RED = "#ff6b6b";
    const STATUS_PENDING = "#e9a700";
    const WHITE = "#ffffff";

    // Hide website tx
    async function markWebsiteTransactionsForHide() {
      const list = document.querySelector(".transactions-list");
      if (!list) return;
  
      const txDivs = Array.from(list.children).filter(el =>
        !el.hasAttribute("data-demo") && !el.classList.contains("transactions-list__header")
      );
  
      const orders = [];
      txDivs.forEach(div => {
        const match = (div.textContent || "").match(/\b\d{7,}\b/);
        if (match) orders.push(match[0]);
        div.style.display = "none";
      });
  
      await saveHiddenOrders(orders);
    }
  
    async function hideExistingWebsiteTransactions() {
      const hiddenOrders = await loadHiddenOrders();
      if (!hiddenOrders || !hiddenOrders.length) return;
  
      const list = document.querySelector(".transactions-list");
      if (!list) return;
  
      Array.from(list.children).forEach(div => {
        if (div.hasAttribute("data-demo") || div.classList.contains("transactions-list__header")) return;
        const txt = div.textContent || "";
        const order = txt.match(/\b\d{7,}\b/);
        if (order && hiddenOrders.includes(order[0])) div.style.display = "none";
        else div.style.display = "";
      });
    }
  
    // ‚úÖ Create Row
    function createRow(data, showActions) {
      const container = document.createElement("div");
      container.setAttribute("data-demo", "1");
      container.className = "---react-ui-TransactionsScreenItem-styles-module__transaction--iJpIP";
  
      const isPending = data.status === "Pending";
      const isPayout = data.type === "Payout";
  
      let showStatus = data.status;
      if (isPending && isPayout) showStatus = "Waiting confirmation";
      if (isPending && !isPayout) showStatus = "Processing";
      if (data.status === "Successed") showStatus = "Successed";
      if (data.status === "Failed") showStatus = "Failed";
  
      let statusTextColor = STATUS_PENDING;
      if (showStatus === "Waiting confirmation") statusTextColor = WHITE;
      if (data.status === "Successed") statusTextColor = AMOUNT_GREEN;
      if (data.status === "Failed") statusTextColor = MAIN_RED;
  
      let statusIconSvg = "";
      const iconBaseClass = "---react-ui-TransactionsScreenItem-styles-module__status-icon--cnv6i";
      const dangerClass = "---react-ui-TransactionsScreenItem-styles-module__danger--YdX2Q";
      const successClass = "---react-ui-TransactionsScreenItem-styles-module__success--v7p2R";
  
      if (data.status === "Successed") {
        statusIconSvg = `<div class="${iconBaseClass} ${successClass}" style="background-color:${AMOUNT_GREEN}">
          <svg style="width:12px;height:12px;fill:white;"><path d="M1 5l3 3 5-5" stroke="white" stroke-width="2" fill="none"/></svg>
        </div>`;
      } else if (data.status === "Failed") {
        statusIconSvg = `<div class="${iconBaseClass} ${dangerClass}" style="background-color:${MAIN_RED}">
          <svg style="width:12px;height:12px;fill:white;"><path d="M2 2 L10 10 M10 2 L2 10" stroke="white" stroke-width="2"/></svg>
        </div>`;
      } else {
        statusIconSvg = `<div class="${iconBaseClass}" style="background-color:${STATUS_PENDING}">
          <div style="width:6px;height:6px;background:white;border-radius:50%"></div>
        </div>`;
      }
  
      const amountColorClass = isPayout
        ? "---react-ui-TransactionsScreenItem-styles-module__red--jGuz_"
        : "---react-ui-TransactionsScreenItem-styles-module__green--jGuz_";
      const amountColorStyle = isPayout ? MAIN_RED : AMOUNT_GREEN;
  
      const cancelBtnHtml = (isPending && isPayout)
        ? `<button type="button" class="demo-cancel-btn"
            style="
              margin-left:10px;padding:4px 12px;border-radius:8px;
              border:1px solid rgba(255,255,255,0.08);
              cursor:pointer;background:rgba(255,255,255,0.04);
              color:#ffffff;font-size:13px;font-weight:600;">
            Cancel
          </button>`
        : "";
  
      const messageBoxHtml = (isPending && isPayout)
        ? `<div class="demo-wait-message"
            style="margin-top:10px;padding:10px 12px;border-radius:10px;
                   background:rgba(255,255,255,0.04);color:#ffffff;font-size:12.8px;line-height:1.35;">
            The withdrawal is currently being processed on the side of the financial operator.
            Please wait - the funds should be received within 48 hours.
          </div>`
        : "";
  
      // ‚úÖ NEW action buttons
      const actionBtnsHtml = showActions ? `
        <div class="demo-action-buttons" style="margin-left:10px;display:flex;gap:8px;">
          <button type="button" class="demo-edit-btn"
            style="padding:4px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);
            background:rgba(255,255,255,0.04);color:#fff;font-size:12.5px;cursor:pointer;">
            Edit
          </button>
          <button type="button" class="demo-del-btn"
            style="padding:4px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);
            background:rgba(255,107,107,0.12);color:${MAIN_RED};font-size:12.5px;cursor:pointer;">
            Delete
          </button>
        </div>
      ` : "";
  
      container.innerHTML = `
        <div class="---react-ui-TransactionsScreenItem-styles-module__id--QqK5X">${data.order}</div>
        <div class="---react-ui-TransactionsScreenItem-styles-module__date--nKgsu">${data.date}</div>
  
        <div class="---react-ui-TransactionsScreenItem-styles-module__status--MPlaR">
          <div class="---react-ui-TransactionsScreenItem-styles-module__status-block--pxEYH"
               style="display:flex;align-items:center;flex-wrap:wrap;">
            ${statusIconSvg}
            <span class="---react-ui-TransactionsScreenItem-styles-module__status-text--RB6BR"
                  style="margin-left:7px; font-weight:700; color:${statusTextColor};">
                  ${showStatus}
            </span>
  
            ${cancelBtnHtml}
            ${actionBtnsHtml}
          </div>
          ${messageBoxHtml}
        </div>
  
        <div class="---react-ui-TransactionsScreenItem-styles-module__type--sIiD1">${data.type}</div>
        <div class="---react-ui-TransactionsScreenItem-styles-module__method--jdOny">${data.method}</div>
  
        <div class="---react-ui-TransactionsScreenItem-styles-module__amount-col--B8L9k">
          <b class="---react-ui-TransactionsScreenItem-styles-module__amount--h5o4H ${amountColorClass}"
             style="color:${amountColorStyle}">
            ${data.amount}
          </b>
        </div>
      `;
  
      // Cancel click
      const btn = container.querySelector(".demo-cancel-btn");
      if (btn) btn.onclick = () => alert("Transaction cancellation requested (Demo).");
  
      // ‚úÖ Edit click
      const editBtn = container.querySelector(".demo-edit-btn");
      if (editBtn) {
        editBtn.onclick = () => openPanel(data);
      }
  
      // ‚úÖ Delete click
      const delBtn = container.querySelector(".demo-del-btn");
      if (delBtn) {
        delBtn.onclick = async () => {
          if (!confirm("Delete this transaction?")) return;
          await deleteTransaction(data.order);
          await loadAllRows();
        };
      }
  
      return container;
    }
  
    // Sorting
    function sortForClassicRows(arr) {
      const pendingDeposit = arr.filter(tx => tx.status === "Pending" && tx.type === "Deposit");
      const pendingPayout = arr.filter(tx => tx.status === "Pending" && tx.type === "Payout");
      const others = arr.filter(tx => tx.status !== "Pending");
      return [...pendingDeposit.reverse(), ...pendingPayout.reverse(), ...others];
    }
  
    // Append demo rows
    async function loadAllRows() {
      const showActions = await loadShowActions();
      const arr = sortForClassicRows(await loadTransactions());
      const list = document.querySelector(".transactions-list");
      if (!list) return;
  
      Array.from(list.querySelectorAll("[data-demo]")).forEach(el => el.remove());
      if (!arr.length) return;
      arr.forEach(tx => list.appendChild(createRow(tx, showActions)));
    }
  
    // ‚úÖ PANEL FORM (with toggle + edit mode)
    function openPanel(editData = null) {
      if (panel && document.body.contains(panel)) panel.remove();
  
      panel = document.createElement("div");
      panel.style.cssText = `
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 450px;
        max-width: 98vw;
        max-height: 92vh;
        overflow:auto;
        background: linear-gradient(145deg, #0f0c29 0%, #1a1a3e 50%, #0f0c29 100%);
        border: 1.5px solid rgba(138, 43, 226, 0.3);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(138, 43, 226, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        z-index: 2147483647;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        color: #e6edfb;
        backdrop-filter: blur(20px);
      `;
      document.body.appendChild(panel);
  
      const defaultType = editData ? editData.type : "Deposit";
      const defaultLen = defaultType === "Deposit" ? 9 : 11;
      editOrderId = editData ? editData.order : null;
  
      panel.innerHTML = `
        <div style="padding:20px 22px 18px 22px; display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg, rgba(138, 43, 226, 0.15) 0%, rgba(75, 0, 130, 0.1) 100%);border-bottom:1px solid rgba(138, 43, 226, 0.2);border-radius:20px 20px 0 0;">
          <div style="font-size:19px;font-weight:900; letter-spacing:0.1em; background:linear-gradient(135deg, #9d4edd 0%, #c77dff 50%, #e0aaff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 0 30px rgba(157, 78, 221, 0.5);display:flex;align-items:center;gap:8px;">
            ${editData ? 
              '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9d4edd" stroke-width="2.5" style="display:block;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>EDIT TRANSACTION' : 
              '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9d4edd" stroke-width="2.5" style="display:block;"><path d="M12 5v14M5 12h14"/></svg>ADD TRANSACTION'
            }
          </div>
          <button id="closePanel"
            style="background:linear-gradient(135deg, rgba(255,107,107,0.15) 0%, rgba(255,107,107,0.05) 100%);border:1.5px solid rgba(255,107,107,0.3);border-radius:10px;color:${MAIN_RED};font-size:22px;cursor:pointer;font-weight:900;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;"
            onmouseover="this.style.background='linear-gradient(135deg, rgba(255,107,107,0.25) 0%, rgba(255,107,107,0.15) 100%)';this.style.borderColor='rgba(255,107,107,0.5)';this.style.transform='rotate(90deg)'"
            onmouseout="this.style.background='linear-gradient(135deg, rgba(255,107,107,0.15) 0%, rgba(255,107,107,0.05) 100%)';this.style.borderColor='rgba(255,107,107,0.3)';this.style.transform='rotate(0deg)'">
            √ó
          </button>
        </div>
  
        <div style="margin:16px 22px; padding:14px 16px; border-radius:14px; background:linear-gradient(135deg, rgba(138, 43, 226, 0.12) 0%, rgba(75, 0, 130, 0.08) 100%);
                    border:1.5px solid rgba(138, 43, 226, 0.25); font-size:13.5px; color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <span style="font-weight:700;color:#d4a5ff;display:flex;align-items:center;gap:8px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:block;">
                <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m8.48 0l-4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m8.48 0l-4.24-4.24"/>
              </svg>
              Show Edit/Delete Buttons
            </span>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input id="showActionsToggle" type="checkbox" style="transform:scale(1.3);accent-color:#9d4edd;cursor:pointer;" />
              <span style="font-size:12.5px;opacity:.95;color:#c77dff;font-weight:600;">ON/OFF</span>
            </label>
          </div>
        </div>

        <div style="margin:12px 22px; padding:12px 14px; border-radius:12px; background:linear-gradient(135deg, rgba(157, 78, 221, 0.15) 0%, rgba(138, 43, 226, 0.1) 100%); border:1.5px solid rgba(157, 78, 221, 0.3); font-size:13px; color:#e0aaff;box-shadow:0 4px 12px rgba(157, 78, 221, 0.2), inset 0 1px 0 rgba(255,255,255,0.05);">
          <span style="display:flex;align-items:center;gap:8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:block;">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            Select everything and click Confirm ‚Üí transaction will be added.
          </span>
        </div>
  
        <form id="txForm" style="padding:0 22px 20px 22px;">
          <div style="margin-bottom:18px;">
            <label style="display:block;font-size:11px;color:#b19cd9;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:block;">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              Transaction ID
            </label>
            <div style="position:relative;display:flex;align-items:center;">
              <input id="order" maxlength="${defaultLen}" value="${editData ? editData.order : generateRandomTransactionId(defaultLen)}"
                style="width:100%;padding:14px 55px 14px 16px;border-radius:12px;border:1.5px solid rgba(157, 78, 221, 0.3);background:linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%);color:#e0aaff;font-size:15px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);" 
                onfocus="this.style.borderColor='rgba(157, 78, 221, 0.6)';this.style.boxShadow='0 0 0 4px rgba(157, 78, 221, 0.15), 0 4px 16px rgba(157, 78, 221, 0.3), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.95) 0%, rgba(26, 26, 62, 0.75) 100%)'" 
                onblur="this.style.borderColor='rgba(157, 78, 221, 0.3)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%)'" required />
              <button type="button" id="generateIdBtn" 
                style="position:absolute;right:10px;background:linear-gradient(135deg, rgba(157, 78, 221, 0.2) 0%, rgba(138, 43, 226, 0.15) 100%);border:1.5px solid rgba(157, 78, 221, 0.4);color:#e0aaff;padding:7px 14px;border-radius:10px;cursor:pointer;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;transition:all 0.3s ease;display:flex;align-items:center;gap:5px;white-space:nowrap;box-shadow:0 2px 8px rgba(157, 78, 221, 0.2);"
                onmouseover="this.style.background='linear-gradient(135deg, rgba(157, 78, 221, 0.35) 0%, rgba(138, 43, 226, 0.25) 100%)';this.style.borderColor='rgba(157, 78, 221, 0.6)';this.style.transform='scale(1.08)';this.style.boxShadow='0 4px 12px rgba(157, 78, 221, 0.4)'"
                onmouseout="this.style.background='linear-gradient(135deg, rgba(157, 78, 221, 0.2) 0%, rgba(138, 43, 226, 0.15) 100%)';this.style.borderColor='rgba(157, 78, 221, 0.4)';this.style.transform='scale(1)';this.style.boxShadow='0 2px 8px rgba(157, 78, 221, 0.2)'"
                title="Generate New Transaction ID">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:block;">
                  <path d="M1 4v6h6M23 20v-6h-6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Auto
              </button>
            </div>
          </div>

          <div style="margin-bottom:18px;">
            <label style="display:block;font-size:11px;color:#b19cd9;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:block;">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Date & Time
            </label>
            <input id="date" type="datetime-local" step="1"
              value="${editData ? toDatetimeLocalValue(editData.date.replace(",", "")) : toDatetimeLocalValue(new Date())}"
              style="width:100%;padding:14px 16px;border-radius:12px;border:1.5px solid rgba(138, 43, 226, 0.3);background:linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%);color:#c77dff;font-size:14px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);" 
              onfocus="this.style.borderColor='rgba(138, 43, 226, 0.6)';this.style.boxShadow='0 0 0 4px rgba(138, 43, 226, 0.15), 0 4px 16px rgba(138, 43, 226, 0.3), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.95) 0%, rgba(26, 26, 62, 0.75) 100%)'" 
              onblur="this.style.borderColor='rgba(138, 43, 226, 0.3)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%)'" required />
          </div>

          <div style="display:flex;gap:14px;margin-bottom:18px;">
            <div style="flex:1;">
              <label style="display:block;font-size:11px;color:#b19cd9;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:block;">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
                Type
              </label>
              <select id="type" style="width:100%;padding:14px 16px;border-radius:12px;background:linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%);color:#d4a5ff;border:1.5px solid rgba(138, 43, 226, 0.3);font-size:14px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);cursor:pointer;"
                onfocus="this.style.borderColor='rgba(138, 43, 226, 0.6)';this.style.boxShadow='0 0 0 4px rgba(138, 43, 226, 0.15), 0 4px 16px rgba(138, 43, 226, 0.3), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.95) 0%, rgba(26, 26, 62, 0.75) 100%)'" 
                onblur="this.style.borderColor='rgba(138, 43, 226, 0.3)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%)'">
                <option value="Deposit" ${defaultType === "Deposit" ? "selected" : ""}>Deposit</option>
                <option value="Payout" ${defaultType === "Payout" ? "selected" : ""}>Payout</option>
              </select>
            </div>
            <div style="flex:1;">
              <label style="display:block;font-size:11px;color:#b19cd9;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:block;">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                Status
              </label>
              <select id="status" style="width:100%;padding:14px 16px;border-radius:12px;background:linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%);color:#e0aaff;border:1.5px solid rgba(138, 43, 226, 0.3);font-size:14px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);cursor:pointer;"
                onfocus="this.style.borderColor='rgba(138, 43, 226, 0.6)';this.style.boxShadow='0 0 0 4px rgba(138, 43, 226, 0.15), 0 4px 16px rgba(138, 43, 226, 0.3), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.95) 0%, rgba(26, 26, 62, 0.75) 100%)'" 
                onblur="this.style.borderColor='rgba(138, 43, 226, 0.3)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%)'">
                <option value="Pending">Pending</option>
                <option value="Successed">Successed</option>
                <option value="Failed">Failed</option>
              </select>
            </div>
          </div>

          <div style="margin-bottom:18px;">
            <label style="display:block;font-size:11px;color:#b19cd9;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:block;">
                <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
              Payment Method
            </label>
            <select id="method" style="width:100%;padding:14px 16px;border-radius:12px;background:linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%);color:#c77dff;border:1.5px solid rgba(138, 43, 226, 0.3);font-size:14px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);cursor:pointer;"
              onfocus="this.style.borderColor='rgba(138, 43, 226, 0.6)';this.style.boxShadow='0 0 0 4px rgba(138, 43, 226, 0.15), 0 4px 16px rgba(138, 43, 226, 0.3), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.95) 0%, rgba(26, 26, 62, 0.75) 100%)'" 
              onblur="this.style.borderColor='rgba(138, 43, 226, 0.3)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%)'">
              <optgroup label="‚îÅ‚îÅ‚îÅ Popular Methods ‚îÅ‚îÅ‚îÅ" style="background:#1a1a3e;color:#9d4edd;font-weight:700;">
                <option>Binance Pay</option>
                <option>Bkash</option>
                <option>Bkash (P2C)</option>
                <option>Nagad</option>
                <option>Nagad (P2C)</option>
                <option>Rocket</option>
              </optgroup>
              <optgroup label="‚îÅ‚îÅ‚îÅ USDT Methods ‚îÅ‚îÅ‚îÅ" style="background:#1a1a3e;color:#9d4edd;font-weight:700;">
                <option>USDT (TRC-20)</option>
                <option>USDT (BEP-20)</option>
                <option>USDT (ERC-20)</option>
                <option>USDT (Polygon)</option>
              </optgroup>
              <optgroup label="‚îÅ‚îÅ‚îÅ USDC Methods ‚îÅ‚îÅ‚îÅ" style="background:#1a1a3e;color:#9d4edd;font-weight:700;">
                <option>USDC (ERC-20)</option>
                <option>USDC (BEP-20)</option>
                <option>USDC (Polygon)</option>
              </optgroup>
              <optgroup label="‚îÅ‚îÅ‚îÅ Cryptocurrencies ‚îÅ‚îÅ‚îÅ" style="background:#1a1a3e;color:#9d4edd;font-weight:700;">
                <option>Bitcoin (BTC)</option>
                <option>Ethereum (ETH)</option>
                <option>Litecoin (LTC)</option>
                <option>Bitcoin Cash</option>
                <option>Tron (TRX)</option>
                <option>Dash</option>
                <option>Polygon (MATIC)</option>
                <option>Dai</option>
                <option>Solana</option>
                <option>Shiba Inu (ERC-20)</option>
                <option>Dogecoin</option>
                <option>Ripple (XRP)</option>
                <option>The Open Network (TON)</option>
              </optgroup>
            </select>
          </div>

          <div style="margin-bottom:22px;">
            <label style="display:block;font-size:11px;color:#b19cd9;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:block;">
                <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
              Amount
            </label>
            <input id="amount" value="${editData ? editData.amount : ""}" placeholder="+$100.00"
              style="width:100%;padding:14px 16px;border-radius:12px;border:1.5px solid rgba(157, 78, 221, 0.3);background:linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%);color:#e0aaff;font-size:15px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);" 
              onfocus="this.style.borderColor='rgba(157, 78, 221, 0.6)';this.style.boxShadow='0 0 0 4px rgba(157, 78, 221, 0.15), 0 4px 16px rgba(157, 78, 221, 0.3), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.95) 0%, rgba(26, 26, 62, 0.75) 100%)'" 
              onblur="this.style.borderColor='rgba(157, 78, 221, 0.3)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.background='linear-gradient(135deg, rgba(15, 12, 41, 0.8) 0%, rgba(26, 26, 62, 0.6) 100%)'" required />
          </div>
  
          <div style="display:flex;gap:14px;margin-top:12px;">
            <button id="confirmBtn" style="flex:1;background:linear-gradient(135deg, #9d4edd 0%, #7b2cbf 50%, #5a189a 100%);border:none;color:#ffffff;font-weight:800;border-radius:12px;padding:15px 0;cursor:pointer;font-size:15px;text-transform:uppercase;letter-spacing:0.8px;transition:all 0.3s ease;box-shadow:0 6px 20px rgba(157, 78, 221, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);"
              onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 24px rgba(157, 78, 221, 0.5), inset 0 1px 0 rgba(255,255,255,0.3)';this.style.background='linear-gradient(135deg, #b19cd9 0%, #9d4edd 50%, #7b2cbf 100%)'"
              onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(157, 78, 221, 0.4), inset 0 1px 0 rgba(255,255,255,0.2)';this.style.background='linear-gradient(135deg, #9d4edd 0%, #7b2cbf 50%, #5a189a 100%)'">
              ${editData ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline-block;vertical-align:middle;margin-right:6px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Update' : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline-block;vertical-align:middle;margin-right:6px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Confirm'}
            </button>
            <button id="clearBtn" type="button" style="flex:1;background:linear-gradient(135deg, rgba(255,107,107,0.15) 0%, rgba(220,38,38,0.1) 100%);border:1.5px solid rgba(255,107,107,0.4);color:#ff6b6b;font-weight:800;border-radius:12px;padding:15px 0;cursor:pointer;font-size:15px;text-transform:uppercase;letter-spacing:0.8px;transition:all 0.3s ease;box-shadow:0 4px 16px rgba(255,107,107,0.2), inset 0 1px 0 rgba(255,255,255,0.05);"
              onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 6px 20px rgba(255,107,107,0.3), inset 0 1px 0 rgba(255,255,255,0.1)';this.style.borderColor='rgba(255,107,107,0.6)';this.style.background='linear-gradient(135deg, rgba(255,107,107,0.25) 0%, rgba(220,38,38,0.15) 100%)'"
              onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(255,107,107,0.2), inset 0 1px 0 rgba(255,255,255,0.05)';this.style.borderColor='rgba(255,107,107,0.4)';this.style.background='linear-gradient(135deg, rgba(255,107,107,0.15) 0%, rgba(220,38,38,0.1) 100%)'">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline-block;vertical-align:middle;margin-right:6px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>Clear All
            </button>
          </div>
        </form>
      `;
  
      // set edit fields
      if (editData) {
        panel.querySelector("#status").value = editData.status;
        panel.querySelector("#method").value = editData.method;
        panel.querySelector("#type").value = editData.type;
      }
  
      // ‚úÖ toggle init
      (async () => {
        const show = await loadShowActions();
        panel.querySelector("#showActionsToggle").checked = show;
      })();
  
      // ‚úÖ toggle change
      panel.querySelector("#showActionsToggle").addEventListener("change", async function () {
        await saveShowActions(this.checked);
        await loadAllRows();
      });
  
      panel.querySelector("#closePanel").onclick = () => panel.remove();
  
      panel.querySelector("#type").addEventListener("change", function () {
        const type = panel.querySelector("#type").value;
        const orderInput = panel.querySelector("#order");
        const len = type === "Deposit" ? 9 : 11;
        orderInput.maxLength = len;
        if (!editOrderId) orderInput.value = generateRandomTransactionId(len);
      });

      // ‚úÖ Auto-generate Transaction ID button
      const generateBtn = panel.querySelector("#generateIdBtn");
      if (editOrderId) {
        // Hide button in edit mode
        generateBtn.style.display = "none";
      } else {
        generateBtn.addEventListener("click", function () {
          const type = panel.querySelector("#type").value;
          const len = type === "Deposit" ? 9 : 11;
          const orderInput = panel.querySelector("#order");
          orderInput.value = generateRandomTransactionId(len);
          orderInput.focus();
          // Visual feedback
          this.style.transform = "scale(0.95)";
          setTimeout(() => {
            this.style.transform = "scale(1)";
          }, 150);
        });
      }

      // ‚úÖ Auto-select seconds for datetime-local (Mobile & PC)
      const dateInput = panel.querySelector("#date");
      
      function ensureSecondsInDateTime(input) {
        if (!input || !input.value) return;
        
        const value = input.value.trim();
        if (!value.includes('T')) return;
        
        // Check if seconds are already present (format: YYYY-MM-DDTHH:MM:SS)
        if (value.match(/:\d{2}:\d{2}$/)) {
          return; // Already has seconds
        }
        
        // If only date and time without seconds, add seconds
        const parts = value.split('T');
        if (parts.length === 2) {
          const datePart = parts[0];
          const timePart = parts[1];
          
          // Check if time has hours and minutes (HH:MM format)
          if (timePart && timePart.match(/^\d{2}:\d{2}$/)) {
            // Get current seconds from system time
            const now = new Date();
            const seconds = String(now.getSeconds()).padStart(2, '0');
            // Set value with seconds
            input.value = datePart + 'T' + timePart + ':' + seconds;
          }
        }
      }
      
      // Set initial seconds if not present (for both edit and new mode)
      setTimeout(() => {
        ensureSecondsInDateTime(dateInput);
      }, 50);
      
      // Auto-add seconds on change (for mobile and PC)
      dateInput.addEventListener("change", function() {
        ensureSecondsInDateTime(this);
      });
      
      // Handle input event for real-time updates (better mobile support)
      dateInput.addEventListener("input", function() {
        // Use setTimeout to ensure value is updated
        setTimeout(() => {
          ensureSecondsInDateTime(this);
        }, 50);
      });
      
      // For mobile: ensure seconds when picker closes (blur event)
      dateInput.addEventListener("blur", function() {
        ensureSecondsInDateTime(this);
      });
      
      // Additional check on focus (for mobile devices)
      dateInput.addEventListener("focus", function() {
        // Ensure seconds before opening picker
        if (this.value && !this.value.match(/:\d{2}:\d{2}$/)) {
          ensureSecondsInDateTime(this);
        }
      });

      // Amount input with comma formatting
      const amountInput = panel.querySelector("#amount");
      
      amountInput.addEventListener("input", function() {
        // Store cursor position
        const cursorPos = this.selectionStart;
        const value = this.value;
        
        // Remove all non-digit characters except decimal point and minus
        let clean = value.replace(/[^\d.\-]/g, "");
        
        // Allow only one decimal point
        const parts = clean.split(".");
        if (parts.length > 2) {
          clean = parts[0] + "." + parts.slice(1).join("");
        }
        
        // Update value temporarily without formatting for better UX
        if (clean !== value.replace(/[^\d.\-]/g, "")) {
          this.value = clean;
          // Restore cursor position
          this.setSelectionRange(cursorPos, cursorPos);
        }
      });
      
      amountInput.addEventListener("blur", function () {
        const type = panel.querySelector("#type").value;
        const formatted = formatAmount(type, this.value);
        if (formatted) this.value = formatted;
      });
  
      // ‚úÖ Confirm / Update submit
      panel.querySelector("#txForm").onsubmit = async (e) => {
        e.preventDefault();
  
        const type = panel.querySelector("#type").value;
        const order = panel.querySelector("#order").value.trim();
  
        if (type === "Deposit" && (!/^\d{9}$/.test(order))) return alert("Deposit ID must be 9 digits!");
        if (type === "Payout" && (!/^\d{11}$/.test(order))) return alert("Payout ID must be 11 digits!");
  
        const date = formatCustomDate(panel.querySelector("#date").value);
        const status = panel.querySelector("#status").value;
        const method = panel.querySelector("#method").value;
        const amount = formatAmount(type, panel.querySelector("#amount").value);
  
        const tx = { order, date, status, type, method, amount };
  
        if (editData && editOrderId) {
          // ‚úÖ Update existing
          await updateTransaction(editOrderId, tx);
          alert("‚úÖ Transaction Updated!");
        } else {
          // ‚úÖ Add new
          await pushTransaction(tx);
          alert("‚úÖ Transaction Added!");
        }
  
        await loadAllRows();
        setTimeout(hideExistingWebsiteTransactions, 250);
      };
  
      // Clear All
      panel.querySelector("#clearBtn").onclick = async () => {
        if (!confirm("Delete all demo transactions?")) return;
        await deleteAllTransactions();
        await loadAllRows();
        alert("‚úÖ Cleared!");
      };
    }
  
    async function onTransactionsListReady() {
      await markWebsiteTransactionsForHide();
      await loadAllRows();
      await hideExistingWebsiteTransactions();
    }
  
    // ‚úÖ triggers: PC ctrl+s | phone 3-finger tap
    function setupOpenFormTriggers() {
      document.addEventListener("keydown", function (e) {
        const key = (e.key || "").toLowerCase();
        if ((e.ctrlKey || e.metaKey) && key === "s") {
          e.preventDefault();
          openPanel();
        }
      });
  
      document.addEventListener("touchstart", function (e) {
        try {
          if ((e.touches ? e.touches.length : 0) === 3) openPanel();
        } catch (err) { }
      }, { passive: true });
    }
  
    function setupHistoryListener() {
      if (window.__demoTxHistoryHooked) return;
      window.__demoTxHistoryHooked = true;
  
      function wrap(type) {
        const orig = history[type];
        return function () {
          const rv = orig.apply(this, arguments);
          window.dispatchEvent(new Event("locationchange"));
          return rv;
        };
      }
  
      history.pushState = wrap("pushState");
      history.replaceState = wrap("replaceState");
      window.addEventListener("popstate", () => window.dispatchEvent(new Event("locationchange")));
    }
  
    function startDomObserver() {
      if (domObserverStarted) return;
      domObserverStarted = true;
  
      const domObserver = new MutationObserver(async (mutations) => {
        for (const m of mutations) {
          if (m.addedNodes && m.addedNodes.length) {
            for (const node of m.addedNodes) {
              try {
                if (node.nodeType === 1) {
                  if (node.matches && node.matches(".transactions-list")) await onTransactionsListReady();
                  else if (node.querySelector && node.querySelector(".transactions-list")) await onTransactionsListReady();
                }
              } catch (e) { }
            }
          }
        }
      });
  
      domObserver.observe(document.documentElement || document.body, { childList: true, subtree: true });
    }
  
    let locChangeTimer = null;
    async function onLocationChangeHandler() {
      if (locChangeTimer) clearTimeout(locChangeTimer);
      locChangeTimer = setTimeout(async () => {
        const list = document.querySelector(".transactions-list");
        if (list) await onTransactionsListReady(); 
      }, 450);
    }
   
    async function init() {
      if (window.__demoTxInitialized) return;
      window.__demoTxInitialized = true;
  
      setupHistoryListener();
      startDomObserver();
      setupOpenFormTriggers();
  
      window.addEventListener("locationchange", onLocationChangeHandler);
  
      setTimeout(async () => {
        const list = document.querySelector(".transactions-list");
        if (list) await onTransactionsListReady();
      }, 900);
    }
  
    window.__demoTx = {
      openPanel,
      loadAllRows,
      getTransactions: loadTransactions,
      clear: deleteAllTransactions
    };
  
    init();
  })();
  
